%===================================================================================================
\subsection{Mixing}\label{model.par.mix}
In addition to more concentrated transmission
among FSW and their clients via regular and occasional sex work partnerships
--- which are \emph{only} formed among FSW and clients ---
other types of partnerships may be formed
preferentially between particular activity groups.
For example, FSW and clients may be more likely to form main or casual partnerships
with each other than with other activity groups.
Such preferences are captured in a ``mixing matrix'' $M$, where $M_{pii'}$ denotes
the total number of type-$p$ partnerships formed between groups $i$ and $i'$ in the population
(ignoring sex indices $s,s'$ temporarily)
--- \ie who has sex with whom.
The mixing matrix $M_{pii'}$ must be symmetric,
and have row/column sums equal to the total numbers of partnerships ``offered'' by any group:
$M_{pi} = P_{i} C_{pi}$ (group size $\times$ partnerships per-person).
%---------------------------------------------------------------------------------------------------
\subsubsection{Classic $\epsilon$ Mixing}\label{model.par.mix.eps}
In many risk/activity-stratified compartmental transmission models,
mixing is parameterized via a single parameter $\epsilon \in [0,1]$,
which controls the degree of like-with-like mixing \cite{Nold1980}.
This approach is often attributed to \cite{Garnett1994},
wherein a key adjustment for imbalanced partner numbers among women \vs men was introduced.
The approach defines the \emph{probability} of
someone from group $i$ forming a \emph{given} type-$p$ partnership with someone from group $i'$ as:
\begin{equation}\label{eq:mix.eps}
  \rho_{pii'} = (\epsilon)\,I_{ii'} + (1 - \epsilon)\,\pi_{ii'},
  \quad I_{ii'} = \begin{cases} ~1 & i = i'\\ ~0 & i \ne i' \end{cases},
  \quad \pi_{ii'} = \frac{M_{pi'}}{\sum_{j}M_{pj}}
\end{equation} where:
$I$ represents complete like-with-like mixing (an identity matrix),
$\pi$ represents random mixing (random but proportional to the number of partnerships ``offered''),
and $\epsilon$ effectively interpolates between these two extremes.
Thus, $\epsilon = 0$ reflects fully random mixing,
and $\epsilon = 1$ reflects fully like-with-like mixing.
Then, the total numbers of type-$p$ partnerships between groups $i$ and $i'$ can be
defined as $M_{pii'} = M_{pi}\,\rho_{pii'}$.
Three advantages of \eqref{eq:mix.eps} are:
(1) simplicity;
(2) $\epsilon$ can be directly interpreted as the proportion of partnerships
which are formed among like-with-like \vs randomly; and
(3) it guarantees that $M$ will be symmetric, even if $P$ and/or $C$ change.
Yet, the simplicity of this approach precludes implementation of more complex mixing patterns
--- such as preferential mixing among two of four total groups ---
although some modest extensions can be made,
such as asymetric age mixing among women and men \cite{Cremin2013}.
%---------------------------------------------------------------------------------------------------
\subsubsection{Log-Linear Mixing}\label{model.par.mix.ll}
A more general  approach to mixing is developed in \cite{Morris1991}.
This ``log-linear'' approach defines the mixing matrix elements $M_{pii'}$ as follows.
The expected total numbers of partnerships between risk groups under random mixing are defined as:
\begin{equation}\label{eq:mix.rand}
  \Pi_{pii'} = \frac{M_{pi} M_{pi'}}{\sum_{j} M_{pj}}
\end{equation}
Next, a matrix $\Phi_{pii'}$ is defined, representing the odds of
a type-$p$ partnership forming between groups $i$ and $i'$, compared to random mixing.
The matrix $\Phi$ must be symmetric,
and can be estimated directly from the right kind of data
(which is rarely available) \cite{Morris1991}.
Then, an initial estimate of $M_{pii'}$ is:
\begin{alignat}{1}
  M_{pii'}^{\,(0)} &= \exp{\left[\log{\left(\Pi_{pii'}\right)} + \Phi_{pii'} \right]} \nonumber\\
                 &= \Pi_{pii'} \exp{\left(\Phi_{pii'}\right)} \label{eq:mix.M0}
\end{alignat}
However, this estimate changes the total numbers of partnerships formed by each group:
$M_{pi}^{\,(0)} \ne \Pi_{pi}$, where
$M_{pi} = \sum_{i'} M_{pii'}$ and $\Pi_{pi} = \sum_{i'} \Pi_{pii'}$.
There is no \textit{a priori} definition of $M_{pii'}$ or adjustment to $\Phi_{pii'}$
that can guarantee the numbers of partnerships will not change.%
\footnote{I hypothesize that this lack of \textit{a priori} solution
  is the reason this approach has not been widely used.}
However, an iterative proportional fitting procedure \cite{Ruschendorf1995}
can resolve an estimate $M_{pii'}^{\,(n)}$ that maintains the total numbers of partnerships:
\begin{equation}\label{eq:mix.iter}
  M_{pii'}^{\,(n+1)} = M_{pii'}^{\,(n)} \frac{\Pi_{pf}}{M_{pf}^{\,(n)}}
  \qquad f = \begin{cases}
    ~i  & \txn{if $n$ is even} \\
    ~i' & \txn{if $n$ is odd}
  \end{cases}
\end{equation}
Each step of this procedure can be understood as
a re-scaling of the current estimate $M_{pii'}^{\,(n)}$
row-wise ($i$) or column-wise ($i'$) to match the numbers of partnerships
offered by individuals ($\Pi_{pi}$) or their partners ($\Pi_{pi'}$).
Each row-step re-introduces discrepancies in the columns, and vice versa,
but overall convergence is guaranteed \cite{Sinkhorn1964}.
\par
In practice, \eqref{eq:mix.iter} adds approximately
one decimal of precision per $2n$ for the $4\times4$ case,
thus 15--20 iterations is often sufficient to come within computational precision limits.
Since the partnerships matrix $M_{pii'}$ should adapt to reflect changes in
group sizes (\eg due to HIV mortality) or
numbers of partnerships offered (\eg see \sref{foi.prop}),
the matrix must be re-computed at every time point.
Thus, the procedure \eqref{eq:mix.iter} could be considered computationally expensive.
However, this approach provides great flexibility and interpretability
to specify complex mixing patterns via the odds matrix $\Phi_{pii'}$.
\par
Adding back the sex dimension indices $i \rightarrow si, ~ i' \rightarrow s'i'$,
two final adjustments are needed for the bipartite (\ie heterosexual) system.
First, I ensure that $M_{s=s'} = \Pi_{s=s'} = 0$.
Second, for the case when the total numbers of partnerships offered by women and men
do not balance ($\sum_j M_{ps_{1}j} \ne \sum_j M_{ps_{2}j}$),
I revise the denominator of \eqref{eq:mix.rand} to $\sum_{j} \omega_s M_{psj}$,
where $\omega_s$ are weights such that $\sum_s \omega_s = 1$.
Similar to the ``compromise'' parameter $\theta$ in \cite{Garnett1994},
if $\omega = \{1,0\}$, then women's partnership numbers are matched exactly
while men adapt their partner numbers to balance;
and conversely for $\omega = \{0,1\}$.
I fixed $\omega = \{0.5,0.5\}$ for equal adaptation among women and men.
%---------------------------------------------------------------------------------------------------
\subsubsection{Odds of Mixing}\label{model.par.mix.odds}
Despite the flexibility in the odds of mixing matrix $\Phi_{pii'}$,
limited data are available to inform specific elements,
especially for Eswatini in particular.
In Kenya \cite{Voeten2007}, Benin, Guinea, and Senegal \cite{Godin2008}, and Uganda \cite{Mbonye2022},
a disproportionate fraction of non-paying partners of FSW were former and/or current clients.
Given this fraction $\psi$ and the proportion of all men who are clients $\rho$,
the odds of these partnerships forming can be computed as:
\begin{equation}
  \Phi = \frac{\psi\,(1-\rho)}{(1-\psi)\,\rho}
\end{equation}
Taking $\psi \in (0.33,~0.70)$ \cite{Voeten2007,Godin2008}
and $\rho \in (5,~20)\%$ \cite{Hodgins2022}, we obtain $\Phi \in (2,~19)$.
As noted in \sref{model.par.pnum.msc}, its not clear whether such partnerships reflect
main/spousal or casual partnerships.
As such, I sampled a common value for both partnership types,
as well as for higher/lower risk FSW and clients:
$\Phi_{p_{12}i_{34}i'_{34}}$ from a gamma prior with 95\%~CI of (2,~19).
I further assumed that lowest activity women and men had
greater odds of forming main/spousal partnerships with each other,
based loosely on age cohorting effects \cite{Leclerc-Madlala2008},
observed like-with-like sexual mixing preferences in numerous other contexts
\cite{Morris1991,Garnett1993a,Admiraal2016},
and prior modelling work \cite{Knight2022sr}.
I sampled $\Phi_{p_{1}i_{1}i'_{1}}$ from a gamma prior with 95\%~CI of (1.5,~3).
I made no further assumptions about preferential mixing (\ie all other elements $\Phi = 1$).
Thus, I assumed that occasional and regular sex work partnerships form
randomly with respect to higher \vs lower FSW and their clients.
